---
title: "Warehouse Industry and Occupation Indicators"
# author: Alex K
# date: 2/4/2020
output: html_document
---

```{r setup, include=FALSE}

# Global display options
knitr::opts_chunk$set(message=FALSE, 
tidy.opts=list(width.cutoff=60)) 

# Packages
library(here)
library(blscrapeR)
library(ipumsr)
library(ggplot2)
library(dplyr)
library(RColorBrewer)

# Graphic print options 
plot_theme <- theme(panel.border = element_blank(), 
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(), 
                    axis.line = element_line(colour = "black"),
                    legend.text=element_text(size=8), 
                    legend.title=element_text(size=10),
                    legend.key = element_rect(colour = NA)) +
  theme_bw()

# Global variables

# Current date
current_date <- Sys.Date()

# Current year 
current_year <- substring(current_date, 1, 4)

# Year to start data gathering
start_year <- 2009 # End of reccesion

```
# Occupational Employment

```{r load_data, include=FALSE}
## Get occupational stats from IPUMS CPS
#   Note: These files need to be regularly updated
# Use basic CPS data for the month of December
# NOTE: I have to add ".." because here() stops at Rproj - figure out how to fix
cps_data_file <- here("..", "..", "..", "..",
                      "data", "supp_data", "ipums", "cps", "cps_00003.dat")
cps_ddi_file <- here("..", "..", "..", "..",
                     "data", "supp_data", "ipums", "cps", "cps_00003.xml")
cps_ddi <- read_ipums_ddi(cps_ddi_file) 
cps_data <- read_ipums_micro(cps_ddi_file, data_file = cps_data_file)

# Create factor variables
cps_data <- cps_data %>%
  mutate(IND_factor = as_factor(IND),
         OCC_factor = as_factor(OCC))

# Occupational codes 

# Industry codes

```

The below figures are based on occupational employment. They cut across industries. They do not include  self-employed, government, or agricultural workers. The following occupational SOC codes are included (Census code in italics; 2011 SOC codes in parentheses):

* **53-7062**: Laborers and Freight, Stock, and Material Movers, Hand, *9620*
* **53-7063**: Machine Feeders and Offbearers, *9630*
* **53-7064**: Packers and Packagers, Hand, *9640*
* **53-7065**: Stockers and Order Fillers, *5620* (43-5081)
* **53-7051**: Industrial Truck and Tractor Operators, *9600*
* **43-5071**: Shipping,  Receiving,  and  Traffic  Clerks, *5610*

This occupational set is comparable but not identical to other studies of warehouse work, including Gutelius and Theodore (2019) and De Lara (2013). It is based on a comparison of these with Sigma's own benchmarks.

## Trend in occupational growth vs U.S. overall

```{r occupational_trends, echo = FALSE}

# All private employees
occ_emp_tot <- cps_data %>%
  # The goal is to self-employed and govt. workers
  #  as well as agricultural workers (low IND codes)
  # Verify if this is good strategy
  filter(EMPSTAT == 10 & IND > 0300 & 
           CLASSWKR %in% c(20, 21, 22, 23)) %>%
  group_by(YEAR) %>%
  summarize(value = sum(WTFINL))

# Warehousing occupcations

whocc_emp_tot <- cps_data %>%
  filter(EMPSTAT == 10 & 
           CLASSWKR %in% c(20, 21, 22, 23) &
           OCC_factor %in% c("9600", "9620", "9630", 
                             "9640", "5610", "5620") &
           # Only in warehousing, temp work, electronic shopping
           IND_factor %in% c("6390", "7580", "5590")) %>%
  group_by(YEAR) %>%
  summarize(value = sum(WTFINL))

# Total number of employees in warehousing occupations in 2009 vs. 2018
cps_data %>%
  filter(EMPSTAT == 10 & YEAR %in% c(2009, 2018) &
           CLASSWKR %in% c(20, 21, 22, 23) &
           OCC_factor %in% c("9600", "9620", "9630", 
                             "9640", "5610", "5620") &
           # Only in warehousing, temp work, 
           IND_factor %in% c("6390", "7580", "5590")) %>%
  group_by(YEAR) %>%
  summarize(total = sum(WTFINL))

# Calculate YoY % change since end of recession
occ_emp_tot_agr <- occ_emp_tot %>%
  arrange(-desc(YEAR)) %>%
  mutate(agr = (value / lag(value, 1)) - 1)

whocc_emp_tot_agr <- whocc_emp_tot %>%
  arrange(-desc(YEAR)) %>%
  mutate(agr = (value / lag(value, 1)) - 1)

# Compare growth rate of all employees vs. warehousing
occ_agr <- rbind(cbind(occ_emp_tot_agr[, c("YEAR", "agr")], "ind" = "all" ), 
             cbind(whocc_emp_tot_agr[, c("YEAR", "agr")], "ind" = "wh"))
occ_agr <- subset(occ_agr, YEAR != 2009)
ggplot(occ_agr, aes(x=YEAR, y=agr, fill = ind)) +
  scale_y_continuous("YoY % Change in Employment Levels", labels = scales::percent) + 
  scale_x_continuous("Year", breaks = occ_agr$YEAR) + 
  geom_bar(stat = "identity", position = 'dodge') +
  scale_fill_manual(values = c("#A31F34", "#7570b3"),
                    labels = c("Private Sector", "Warehousing")) +
  labs(title = "U.S. Annual Growth in Warehousing Occupations vs. All Occupations Since the Recession", 
       subtitle = "Warehousing: SOC 53-7051, 7062, 7063, 7064, 7065, 43-5071; All: Except self-employed, gov't, and ag workers",
       caption = "Source: BLS CPS",
       fill = "Industry") +
  guides(linetype = FALSE) 

```

### Source

## Annual change in employment

## Industries with largest share of workers in these occupations

## Most common occupations in Warehousing and Storage Industry (NAICS 493)

## Where is Amazon?
It is likely in NAICS 45411 (read Mandel?), though this number includes

## What happens if we add Amazon industry to NACIS 493?

## Share of temps

# Industry employment

This displays *name*. It should update automatically.

```{r, echo=FALSE, eval=FALSE}

# Right now this isn't working because you only have liek 10 requests a day.
# This means I need to download the file and save it once a month, automatically.
#  Next step: create separate R file to do this.
#  Consider using this: https://cran.r-project.org/web/packages/taskscheduleR/vignettes/taskscheduleR.html

## Industry Employment Growth ##

# Get data from BLS
# All employees, thousands, total private, seasonally adjusted
emp_tot <- bls_api("CES0500000001",
              startyear = start_year, 
              endyear = current_year,
              Sys.getenv("BLS_KEY")) %>%
# Add time-series dates
dateCast()
emp_tot$date <- as.Date(emp_tot$date)

# Name series
emp_tot$name <- "Total private"

#  All employees, thousands, warehousing and storage, seasonally adjusted
wh_tot <- bls_api("CES4349300001",
                   startyear = start_year, 
                   endyear = current_year,
                   Sys.getenv("BLS_KEY")) %>%
# Add time-series dates
dateCast()
wh_tot$date <- as.Date(emp_tot$date)

# Name series
emp_tot$name <- "Total private"

ggplot(rbind(emp_tot, wh_tot),
       aes(x = date, 
           y = value)) +
  facet_grid(name~., scale="free") + 
  geom_line() +
  labs(title = "Title",
       x = "Date",
       y = "All employees (thousands)") +
  plot_theme

```

### Source

After each graphic, I want to print where it is from <http://rmarkdown.rstudio.com>.
Note: This snapshot is a subindustry of Transportation and Warehousing (Naics 48-49). It does not include transportation jobs.

# Establishments

# Work Hours

### Citations
Gutelius and Theodore (2019) - fill these out
De Lara (2013)